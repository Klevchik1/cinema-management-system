<!-- ticket/templates/ticket/screening_partial.html -->
<div class="screening-details">
    <h2 style="color: #ffcc00; margin-bottom: 20px; text-align: center;">
        –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ–∞–Ω—Å–µ
    </h2>

    <div class="info-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;">
        <div class="info-item" style="background: rgba(20, 20, 20, 0.7); padding: 15px; border-radius: 8px;">
            <strong>–ù–∞—á–∞–ª–æ:</strong><br>
            {{ screening.start_time|date:"d F Y H:i" }}
        </div>
        <div class="info-item" style="background: rgba(20, 20, 20, 0.7); padding: 15px; border-radius: 8px;">
            <strong>–û–∫–æ–Ω—á–∞–Ω–∏–µ:</strong><br>
            {{ screening.end_time|date:"d F Y H:i" }}
        </div>
        <div class="info-item" style="background: rgba(20, 20, 20, 0.7); padding: 15px; border-radius: 8px;">
            <strong>–ó–∞–ª:</strong><br>
            {{ screening.hall.name }}
        </div>
        <div class="info-item" style="background: rgba(20, 20, 20, 0.7); padding: 15px; border-radius: 8px;">
            <strong>–¶–µ–Ω–∞ –∑–∞ –º–µ—Å—Ç–æ:</strong><br>
            {{ screening.price }} ‚ÇΩ
        </div>
    </div>

    <!-- –°—Ö–µ–º–∞ –∑–∞–ª–∞ -->
    <div class="cinema-hall">
        <div class="screen" style="background: #333; color: white; padding: 15px; margin-bottom: 30px; border-radius: 5px; font-size: 20px; font-weight: bold; box-shadow: 0 0 10px rgba(255, 204, 0, 0.5); text-align: center;">
            –≠–ö–†–ê–ù
        </div>

        <div id="selected-seats-info-{{ screening.id }}" style="margin: 20px 0; font-size: 20px; font-weight: bold; color: #ffcc00; text-align: center;">
            –í—ã–±—Ä–∞–Ω–æ –º–µ—Å—Ç: 0
        </div>

        {% for row, seats in rows.items %}
        <div class="row" style="display: flex; justify-content: center; margin-bottom: 10px;">
            <div class="row-label" style="width: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #ffcc00;">
                –†—è–¥ {{ row }}
            </div>
            {% for seat in seats %}
            <div class="seat {% if seat.id in booked_seat_ids %}booked{% endif %}"
                 data-seat-id="{{ seat.id }}"
                 data-row="{{ seat.row }}"
                 data-number="{{ seat.number }}"
                 onclick="selectSeatPartial(this, {{ screening.id }})"
                 style="width: 45px; height: 45px; margin: 0 5px; display: flex; justify-content: center; align-items: center; background-color: {% if seat.id in booked_seat_ids %}#f44336{% else %}#4CAF50{% endif %}; color: white; cursor: {% if seat.id in booked_seat_ids %}not-allowed{% else %}pointer{% endif %}; border-radius: 5px; position: relative; transition: all 0.2s; font-weight: bold; user-select: none; opacity: {% if seat.id in booked_seat_ids %}0.7{% else %}1{% endif %};">
                {{ seat.row }}-{{ seat.number }}
                <span class="seat-number" style="font-size: 10px; position: absolute; bottom: 2px; right: 2px;">
                    {{ seat.number }}
                </span>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>

    <!-- –§–æ—Ä–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div class="action-buttons" style="margin-top: 30px; text-align: center;">
        <form method="post" action="{% url 'book_tickets' %}">
            {% csrf_token %}
            <input type="hidden" name="screening_id" value="{{ screening.id }}">
            <input type="hidden" name="selected_seats" id="selected-seats-input-{{ screening.id }}" value="">
            <button type="submit" class="btn-buy" id="book-button-{{ screening.id }}" disabled
                    style="display: inline-block; background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%); color: #fff; padding: 12px 25px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 1px; text-decoration: none; margin-top: 15px; opacity: 0.6; cursor: not-allowed;">
                –ö—É–ø–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –±–∏–ª–µ—Ç—ã
            </button>
        </form>
    </div>

    {% if not user.is_authenticated %}
    <div class="guest-notification" style="
        background: rgba(255, 204, 0, 0.1);
        border: 2px solid #ffcc00;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
        text-align: center;
    ">
        <h3 style="color: #ffcc00; margin-bottom: 15px;">üîê –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
        <p style="color: #fff; margin-bottom: 20px;">
            –î–ª—è –ø–æ–∫—É–ø–∫–∏ –±–∏–ª–µ—Ç–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É
        </p>
        <div style="display: flex; gap: 15px; justify-content: center;">
            <a href="{% url 'login' %}?next={{ request.path }}" class="btn-buy" style="
                background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
            ">
                –í–æ–π—Ç–∏
            </a>
            <a href="{% url 'register' %}?next={{ request.path }}" class="btn-buy" style="
                background: linear-gradient(135deg, #4a00e0 0%, #8e2de2 100%);
            ">
                –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
            </a>
        </div>
    </div>

    <script>
    // –î–ª—è –≥–æ—Å—Ç–µ–π —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–∫—É–ø–∫–∏ –∏ –¥–µ–ª–∞–µ–º –º–µ—Å—Ç–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º–∏
    document.addEventListener('DOMContentLoaded', function() {
        const bookButton = document.getElementById('book-button-{{ screening.id }}');
        if (bookButton) {
            bookButton.style.display = 'none';
        }

        // –î–µ–ª–∞–µ–º –º–µ—Å—Ç–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º–∏ –¥–ª—è –≥–æ—Å—Ç–µ–π
        const seats = document.querySelectorAll('.seat:not(.booked)');
        seats.forEach(seat => {
            seat.style.cursor = 'not-allowed';
            seat.style.opacity = '0.6';
            seat.onclick = null;
        });
    });
    </script>
    {% endif %}
</div>

<script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ–∞–Ω—Å–∞
    let selectedSeats{{ screening.id }} = [];
    const selectedSeatsInfo{{ screening.id }} = document.getElementById('selected-seats-info-{{ screening.id }}');
    const selectedSeatsInput{{ screening.id }} = document.getElementById('selected-seats-input-{{ screening.id }}');
    const bookButton{{ screening.id }} = document.getElementById('book-button-{{ screening.id }}');

    // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É –∏–∑ Django –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á–∏—Å–ª–æ
    const priceText{{ screening.id }} = '{{ screening.price }}';
    const screeningPrice{{ screening.id }} = parseFloat(priceText{{ screening.id }}.replace(',', '.'));

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –º–µ—Å—Ç–∞ (–¥–ª—è —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è)
    function selectSeatPartial(seatElement, screeningId) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–Ω—è—Ç–æ –ª–∏ –º–µ—Å—Ç–æ
        if (seatElement.classList.contains('booked')) {
            return;
        }

        const seatId = seatElement.getAttribute('data-seat-id');
        const seatRow = seatElement.getAttribute('data-row');
        const seatNumber = seatElement.getAttribute('data-number');

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —ç—Ç–æ–≥–æ —Å–µ–∞–Ω—Å–∞
        let selectedSeats, selectedSeatsInfo, selectedSeatsInput, bookButton, screeningPrice;

        switch(screeningId) {
            case {{ screening.id }}:
                selectedSeats = selectedSeats{{ screening.id }};
                selectedSeatsInfo = selectedSeatsInfo{{ screening.id }};
                selectedSeatsInput = selectedSeatsInput{{ screening.id }};
                bookButton = bookButton{{ screening.id }};
                screeningPrice = screeningPrice{{ screening.id }};
                break;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω–æ –ª–∏ —É–∂–µ —ç—Ç–æ –º–µ—Å—Ç–æ
        const seatIndex = selectedSeats.indexOf(seatId);

        if (seatIndex === -1) {
            // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Å—Ç–æ
            selectedSeats.push(seatId);
            seatElement.classList.add('selected');
            seatElement.style.backgroundColor = '#2196F3';
            seatElement.style.transform = 'scale(1.1)';
            seatElement.style.boxShadow = '0 0 10px rgba(33, 150, 243, 0.7)';
        } else {
            // –£–±–∏—Ä–∞–µ–º –º–µ—Å—Ç–æ
            selectedSeats.splice(seatIndex, 1);
            seatElement.classList.remove('selected');
            seatElement.style.backgroundColor = '#4CAF50';
            seatElement.style.transform = 'scale(1)';
            seatElement.style.boxShadow = 'none';
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
        updateSelectedSeatsInfoPartial(selectedSeats, selectedSeatsInfo, selectedSeatsInput, bookButton, screeningPrice);
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö (–¥–ª—è —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è)
    function updateSelectedSeatsInfoPartial(selectedSeats, selectedSeatsInfo, selectedSeatsInput, bookButton, screeningPrice) {
        const count = selectedSeats.length;
        const totalPrice = count * screeningPrice;

        if (count === 0) {
            selectedSeatsInfo.textContent = '–í—ã–±—Ä–∞–Ω–æ –º–µ—Å—Ç: 0';
            bookButton.disabled = true;
            bookButton.style.opacity = '0.6';
            bookButton.style.cursor = 'not-allowed';
        } else {
            selectedSeatsInfo.textContent = `–í—ã–±—Ä–∞–Ω–æ –º–µ—Å—Ç: ${count}, –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${totalPrice.toFixed(2)} ‚ÇΩ`;
            bookButton.disabled = false;
            bookButton.style.opacity = '1';
            bookButton.style.cursor = 'pointer';
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Ñ–æ—Ä–º—ã
        if (selectedSeatsInput) {
            selectedSeatsInput.value = JSON.stringify(selectedSeats);
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —ç—Ç–æ–≥–æ —Å–µ–∞–Ω—Å–∞
    document.addEventListener('DOMContentLoaded', function() {
        updateSelectedSeatsInfoPartial(
            selectedSeats{{ screening.id }},
            selectedSeatsInfo{{ screening.id }},
            selectedSeatsInput{{ screening.id }},
            bookButton{{ screening.id }},
            screeningPrice{{ screening.id }}
        );
    });
</script>