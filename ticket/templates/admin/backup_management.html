{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
{{ block.super }}
<style>
    .backup-section {
        background: var(--darkened-bg);
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        border: 1px solid var(--border-color);
        color: var(--body-fg);
    }
    .backup-form {
        margin: 15px 0;
        padding: 15px;
        background: var(--body-bg);
        border-radius: 4px;
        border: 1px solid var(--border-color);
    }
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin: 5px;
        text-decoration: none;
        display: inline-block;
    }
    .btn-primary {
        background: var(--primary);
        color: var(--button-fg);
    }
    .btn-secondary {
        background: var(--secondary);
        color: var(--button-fg);
    }
    .btn-success {
        background: #4caf50;
        color: white;
    }
    .btn-warning {
        background: #ff9800;
        color: white;
    }
    .btn-danger {
        background: #f44336;
        color: white;
    }
    .btn:hover {
        opacity: 0.9;
    }
    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .backup-list {
        margin-top: 20px;
    }
    .backup-item {
        background: var(--body-bg);
        padding: 15px;
        margin: 10px 0;
        border-radius: 4px;
        border-left: 4px solid var(--primary);
        color: var(--body-fg);
        position: relative;
    }
    .backup-item.restoring {
        border-left-color: #ff9800;
        background: rgba(255, 152, 0, 0.1);
    }
    .backup-item.completed {
        border-left-color: #4caf50;
        background: rgba(76, 175, 80, 0.1);
    }
    .backup-item.failed {
        border-left-color: #f44336;
        background: rgba(244, 67, 54, 0.1);
    }
    .backup-actions {
        margin-top: 10px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    .form-group {
        margin: 15px 0;
    }
    label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: var(--body-fg);
    }
    input[type="date"] {
        padding: 8px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 14px;
        margin-right: 10px;
        background: var(--body-bg);
        color: var(--body-fg);
    }
    h1, h2, h3 {
        color: var(--body-fg);
    }
    p {
        color: var(--body-fg);
    }
    .status-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
        margin-left: 10px;
    }
    .restoration-log {
        margin-top: 10px;
        padding: 10px;
        background: var(--darkened-bg);
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        white-space: pre-wrap;
        max-height: 200px;
        overflow-y: auto;
        display: none;
    }
    .log-toggle {
        color: var(--link-fg);
        cursor: pointer;
        font-size: 12px;
        margin-top: 5px;
        display: inline-block;
    }
    .log-toggle:hover {
        text-decoration: underline;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
        background-color: var(--body-bg);
        margin: 15% auto;
        padding: 20px;
        border: 1px solid var(--border-color);
        width: 500px;
        border-radius: 8px;
        color: var(--body-fg);
    }
    .modal-actions {
        text-align: right;
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div id="content-main">
    <h1>üóÉÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—ç–∫–∞–ø–∞–º–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h1>

    <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
    {% if messages %}
        <ul class="messagelist">
            {% for message in messages %}
                <li class="{% if message.tags %}{{ message.tags }}{% endif %}">
                    {{ message }}
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    <!-- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ -->
    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 4px; margin-bottom: 20px; color: #856404;">
        <strong>‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ!</strong> –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ.
        –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å —Å–≤–µ–∂–∏–π –±—ç–∫–∞–ø –ø–µ—Ä–µ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º.
    </div>

    <!-- –°–µ–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–æ–≤ -->
    <div class="backup-section">
        <h2>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –±—ç–∫–∞–ø</h2>

        <!-- –ü–æ–ª–Ω—ã–π –±—ç–∫–∞–ø -->
        <div class="backup-form">
            <h3>–ü–æ–ª–Ω—ã–π –±—ç–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h3>
            <p>–°–æ–∑–¥–∞–µ—Ç –ø–æ–ª–Ω—É—é –∫–æ–ø–∏—é –≤—Å–µ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</p>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="full_backup">
                <button type="submit" class="btn btn-primary">
                    üóÉÔ∏è –°–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω—ã–π –±—ç–∫–∞–ø
                </button>
            </form>
        </div>

        <!-- –î–Ω–µ–≤–Ω–æ–π –±—ç–∫–∞–ø -->
        <div class="backup-form">
            <h3>–ë—ç–∫–∞–ø –∑–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –¥–µ–Ω—å</h3>
            <p>–°–æ–∑–¥–∞–µ—Ç –±—ç–∫–∞–ø –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É</p>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="daily_backup">
                <div class="form-group">
                    <label for="backup_date">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É:</label>
                    <input type="date" id="backup_date" name="backup_date" required>
                    <button type="submit" class="btn btn-secondary">
                        üìÖ –°–æ–∑–¥–∞—Ç—å –¥–Ω–µ–≤–Ω–æ–π –±—ç–∫–∞–ø
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –±—ç–∫–∞–ø–æ–≤ -->
    <div class="backup-section">
        <h2>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –±—ç–∫–∞–ø—ã</h2>

        {% if backups %}
            <div class="backup-list">
                {% for backup in backups %}
                    <div class="backup-item {{ backup.restoration_status }}">
                        <strong>{{ backup.name }}</strong>
                        <span class="status-badge" style="background: {{ backup.get_restoration_color }}; color: white;">
                            {{ backup.get_restoration_status_display }}
                        </span>
                        <br>
                        <small>–§–∞–π–ª: {{ backup.backup_file }}</small><br>
                        <small>–¢–∏–ø: {{ backup.get_backup_type_display }}</small><br>
                        <small>–î–∞—Ç–∞: {{ backup.backup_date|default:"-" }}</small><br>
                        <small>–°–æ–∑–¥–∞–Ω: {{ backup.created_at|date:"Y-m-d H:i:s" }}</small><br>
                        <small>–†–∞–∑–º–µ—Ä: {{ backup.file_size }}</small><br>

                        {% if backup.restoration_log %}
                            <div class="log-toggle" onclick="toggleLog({{ backup.id }})">
                                üìã –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
                            </div>
                            <div id="log-{{ backup.id }}" class="restoration-log">
                                {{ backup.restoration_log }}
                            </div>
                        {% endif %}

                        <div class="backup-actions">
                            {% if backup.file_exists %}
                                <a href="javascript:void(0)"
                                   onclick="confirmRestore({{ backup.id }}, '{{ backup.name|escapejs }}')"
                                   class="btn btn-success"
                                   {% if backup.restoration_status == 'in_progress' %}disabled{% endif %}>
                                    üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ë–î
                                </a>
                                <a href="/backups/{{ backup.backup_file }}"
                                   class="btn btn-secondary"
                                   download>
                                    ‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å
                                </a>
                            {% else %}
                                <button class="btn btn-danger" disabled>
                                    ‚ùå –§–∞–π–ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
                                </button>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p>–ë—ç–∫–∞–ø—ã –ø–æ–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã</p>
        {% endif %}
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ -->
    <div style="margin-top: 20px;">
        <a href="{% url 'admin:ticket_backupmanager_changelist' %}" class="btn" style="background: var(--secondary); color: var(--button-fg);">
            ‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –±—ç–∫–∞–ø–æ–≤
        </a>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <h3>‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ë–î</h3>
        <p>–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±—ç–∫–∞–ø–∞: <strong id="backupName"></strong></p>
        <p><strong>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ:</strong></p>
        <ul>
            <li>–ü–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ</li>
            <li>–ú–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç</li>
            <li>–ù–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–º–µ–Ω–µ–Ω–æ</li>
        </ul>
        <p style="color: #f44336; font-weight: bold;">
            ‚ö†Ô∏è –ü–µ—Ä–µ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å —Å–≤–µ–∂–∏–π –±—ç–∫–∞–ø —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö!
        </p>
        <div class="modal-actions">
            <button onclick="closeModal()" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
            <button onclick="performRestore()" class="btn btn-danger" id="restoreBtn">
                üîÑ –î–∞, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ë–î
            </button>
        </div>
    </div>
</div>

<script>
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É –∫–∞–∫ —Å–µ–≥–æ–¥–Ω—è
    document.getElementById('backup_date').max = new Date().toISOString().split('T')[0];

    let currentBackupId = null;
    let currentBackupName = '';

    function toggleLog(backupId) {
        const logElement = document.getElementById('log-' + backupId);
        const toggleElement = logElement.previousElementSibling;

        if (logElement.style.display === 'block') {
            logElement.style.display = 'none';
            toggleElement.textContent = 'üìã –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è';
        } else {
            logElement.style.display = 'block';
            toggleElement.textContent = 'üìã –°–∫—Ä—ã—Ç—å –ª–æ–≥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è';
        }
    }

    function confirmRestore(backupId, backupName) {
        currentBackupId = backupId;
        currentBackupName = backupName;

        document.getElementById('backupName').textContent = backupName;
        document.getElementById('confirmModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('confirmModal').style.display = 'none';
        currentBackupId = null;
        currentBackupName = '';
    }

    function performRestore() {
        const restoreBtn = document.getElementById('restoreBtn');
        restoreBtn.disabled = true;
        restoreBtn.innerHTML = '‚è≥ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ...';

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
        fetch(`/admin/ticket/backupmanager/restore-backup/${currentBackupId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—á–∞—Ç–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ.');
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + data.message);
                restoreBtn.disabled = false;
                restoreBtn.innerHTML = 'üîÑ –î–∞, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ë–î';
            }
            closeModal();
        })
        .catch(error => {
            alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error);
            restoreBtn.disabled = false;
            restoreBtn.innerHTML = 'üîÑ –î–∞, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ë–î';
            closeModal();
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    window.onclick = function(event) {
        const modal = document.getElementById('confirmModal');
        if (event.target == modal) {
            closeModal();
        }
    }
</script>
{% endblock %}