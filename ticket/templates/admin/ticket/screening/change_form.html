{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ) */
#id_price_calculation {
    background-color: var(--body-bg);
    color: var(--body-fg);
    border: 1px solid var(--border-color);
    padding: 12px;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.4;
    border-radius: 4px;
    margin-top: 8px;
    white-space: pre;
    width: 100%;
    max-width: 800px;
    height: 220px;
    resize: vertical;
    overflow: auto;
}

/* –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
@media (prefers-color-scheme: dark), 
       [data-theme="dark"] {
    
    #id_price_calculation {
        background-color: #1a1a1a !important;
        color: #e0e0e0 !important;
        border-color: #444 !important;
    }
    
    /* –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
    .field-price_calculation .help {
        color: #aaa !important;
    }
}

/* –ü–æ–ª–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–æ–π —Ü–µ–Ω—ã */
#id_price {
    background-color: var(--body-bg);
    color: var(--body-fg);
    border: 1px solid var(--border-color);
    font-weight: bold;
    padding: 8px 12px;
    width: 200px;
    font-size: 16px;
    text-align: center;
}

/* –î–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
@media (prefers-color-scheme: dark),
       [data-theme="dark"] {
    
    #id_price {
        background-color: #1a1a1a !important;
        color: #fff !important;
        border-color: #555 !important;
    }
}

/* –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è —Å–µ–∫—Ü–∏–∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ */
.field-calculated_price label,
.field-price_calculation label {
    font-weight: bold;
    color: var(--body-fg);
    margin-bottom: 8px;
    display: block;
}

/* –í —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ */
@media (prefers-color-scheme: dark),
       [data-theme="dark"] {
    
    .field-calculated_price label,
    .field-price_calculation label {
        color: #fff !important;
    }
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–æ–ª–µ–π —Ä–∞—Å—á–µ—Ç–∞ */
.module .aligned .form-row {
    padding: 10px 0;
}

/* –£–ª—É—á—à–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –≤ –∞–¥–º–∏–Ω–∫–µ */
.form-row.field-price_calculation textarea {
    margin-top: 5px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏ */
.time-input-wrapper {
    display: flex;
    align-items: center;
    gap: 5px;
    margin-top: 5px;
}

.time-input-wrapper select {
    min-width: 80px;
    padding: 5px;
    border: 1px solid var(--border-color);
    border-radius: 3px;
    background-color: var(--body-bg);
    color: var(--body-fg);
}

/* –î–ª—è –ø–æ–ª—è –≤—Ä–µ–º–µ–Ω–∏ –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
@media (prefers-color-scheme: dark),
       [data-theme="dark"] {
    
    .time-input-wrapper select {
        background-color: #2a2a2a;
        color: #fff;
        border-color: #555;
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∏—Ç–æ–≥–æ–≤–æ–π —Ü–µ–Ω—ã */
.price-highlight {
    background-color: #e8f5e8 !important;
    color: #155724 !important;
    border-color: #c3e6cb !important;
}

@media (prefers-color-scheme: dark),
       [data-theme="dark"] {
    
    .price-highlight {
        background-color: #1a472a !important;
        color: #90ee90 !important;
        border-color: #2e8b57 !important;
    }
}
</style>
{% endblock %}

{% block admin_change_form_document_ready %}
{{ block.super }}
<script>
// JavaScript –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π)
document.addEventListener('DOMContentLoaded', function() {
    console.log('Screening price calculation - embedded version');
    
    // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç—ã
    const hallSelect = document.getElementById('id_hall');
    const priceField = document.getElementById('id_price');
    const calculationField = document.getElementById('id_price_calculation');
    
    // –ò—â–µ–º –ø–æ–ª—è –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏
    let dateInput = document.getElementById('id_start_date');
    let hourSelect = document.getElementById('id_start_time_0');
    let minuteSelect = document.getElementById('id_start_time_1');
    
    // –ï—Å–ª–∏ –Ω–µ—Ç —ç—Ç–∏—Ö –ø–æ–ª–µ–π, –∏—â–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ
    if (!dateInput) {
        dateInput = document.querySelector('input[name="start_time_0"]');
    }
    if (!hourSelect) {
        hourSelect = document.querySelector('select[name="start_time_1"]');
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
    function getTimeValue() {
        if (hourSelect && minuteSelect) {
            const hour = hourSelect.value;
            const minute = minuteSelect.value;
            if (hour && minute) {
                return hour + ':' + minute;
            }
        } else if (hourSelect) {
            // –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ Django
            return hourSelect.value;
        }
        return null;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã
    function calculatePrice() {
        console.log('Calculating price...');
        
        const hallId = hallSelect ? hallSelect.value : null;
        const dateValue = dateInput ? dateInput.value : null;
        const timeValue = getTimeValue();
        
        if (!hallId || !dateValue || !timeValue) {
            if (calculationField) {
                calculationField.value = '–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ª, –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è —Å–µ–∞–Ω—Å–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã';
            }
            if (priceField) {
                priceField.value = '';
                priceField.classList.remove('price-highlight');
            }
            return;
        }
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∞—Å –∏–∑ –≤—Ä–µ–º–µ–Ω–∏
        let hour = 12;
        if (timeValue && timeValue.includes(':')) {
            hour = parseInt(timeValue.split(':')[0]);
        } else if (timeValue) {
            hour = parseInt(timeValue);
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–ª–∞
        const hallName = hallSelect.options[hallSelect.selectedIndex].text;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª—å –≤—Ä–µ–º–µ–Ω–∏
        let timeMultiplier = 1.0;
        let timeDesc = '';
        
        if (8 <= hour && hour < 12) {
            timeMultiplier = 0.7;
            timeDesc = '—É—Ç—Ä–æ (' + hour + ':00)';
        } else if (12 <= hour && hour < 16) {
            timeMultiplier = 0.9;
            timeDesc = '–¥–µ–Ω—å (' + hour + ':00)';
        } else if (16 <= hour && hour < 20) {
            timeMultiplier = 1.2;
            timeDesc = '–≤–µ—á–µ—Ä (' + hour + ':00)';
        } else {
            timeMultiplier = 1.4;
            timeDesc = '–Ω–æ—á—å (' + hour + ':00)';
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∑–∞–ª–∞ –∏ –±–∞–∑–æ–≤—É—é —Ü–µ–Ω—É
        let hallType = '–°—Ç–∞–Ω–¥–∞—Ä—Ç';
        let basePrice = 350;
        
        const hallNameLower = hallName.toLowerCase();
        if (hallNameLower.includes('vip')) {
            hallType = 'VIP';
            basePrice = 1100;
        } else if (hallNameLower.includes('love')) {
            hallType = 'Love Hall';
            basePrice = 900;
        } else if (hallNameLower.includes('–∫–æ–º—Ñ–æ—Ä—Ç') || hallNameLower.includes('comfort')) {
            hallType = '–ö–æ–º—Ñ–æ—Ä—Ç';
            basePrice = 550;
        } else if (hallNameLower.includes('imax')) {
            hallType = 'IMAX';
            basePrice = 800;
        }
        
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Ü–µ–Ω—É
        const finalPrice = Math.round(basePrice * timeMultiplier);
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Ä–∞—Å—á–µ—Ç–∞
        const calculationText = 
            '‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n' +
            '‚ïë      üìä –†–ê–°–ß–ï–¢ –°–¢–û–ò–ú–û–°–¢–ò –ë–ò–õ–ï–¢–ê             ‚ïë\n' +
            '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n\n' +
            '‚Ä¢ –ó–∞–ª: "' + hallName + '"\n' +
            '  ‚îî‚îÄ‚îÄ –¢–∏–ø: ' + hallType + '\n' +
            '  ‚îî‚îÄ‚îÄ –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞: ' + basePrice + ' —Ä—É–±.\n\n' +
            '‚Ä¢ –í—Ä–µ–º—è —Å–µ–∞–Ω—Å–∞: ' + timeDesc + '\n' +
            '  ‚îî‚îÄ‚îÄ –ú–Ω–æ–∂–∏—Ç–µ–ª—å –≤—Ä–µ–º–µ–Ω–∏: √ó' + timeMultiplier + '\n\n' +
            '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n' +
            '  –§–û–†–ú–£–õ–ê: ' + basePrice + ' —Ä—É–±. √ó ' + timeMultiplier + '\n' +
            '  –ò–¢–û–ì–û: ' + finalPrice + ' —Ä—É–±.\n' +
            '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n' +
            'üìù –¶–µ–Ω–∞ –±—É–¥–µ—Ç –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è
        if (calculationField) {
            calculationField.value = calculationText;
        }
        
        if (priceField) {
            priceField.value = finalPrice;
            priceField.classList.add('price-highlight');
        }
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    if (hallSelect) hallSelect.addEventListener('change', calculatePrice);
    if (dateInput) dateInput.addEventListener('change', calculatePrice);
    if (hourSelect) hourSelect.addEventListener('change', calculatePrice);
    if (minuteSelect) minuteSelect.addEventListener('change', calculatePrice);
    
    // –¢–∞–∫–∂–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –≤–≤–æ–¥ –≤—Ä—É—á–Ω—É—é
    if (dateInput && dateInput.type === 'text') {
        dateInput.addEventListener('input', function() {
            clearTimeout(window.dateTimeout);
            window.dateTimeout = setTimeout(calculatePrice, 300);
        });
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å—á–µ—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    setTimeout(calculatePrice, 500);
    
    console.log('Price calculation initialized');
});
</script>
{% endblock %}