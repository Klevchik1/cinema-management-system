@login_required
@require_POST
def request_ticket_refund(request, ticket_id):
    ticket = get_object_or_404(Ticket, id=ticket_id, user=request.user)
    
    # Автоматическая проверка всех условий возврата
    success, message = ticket.request_refund()
    
    if success:
        # Автоматическое обновление статуса и логирование
        refunded_status = TicketStatus.objects.get(code='refunded')
        ticket.status = refunded_status
        ticket.refund_processed_at = timezone.now()
        ticket.save()
        
        OperationLogger.log_operation(
            request=request,
            action_type='UPDATE',
            module_type='TICKETS',
            description=f'Автоматический возврат билета #{ticket_id}'
        )
        
        messages.success(request, '✅ Билет успешно возвращен!')
    
    return redirect('profile')