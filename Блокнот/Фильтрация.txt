# cinema-management-system/ticket/views.py
def home(request):
    # Применение фильтров из GET-параметров
    search_query = request.GET.get('search', '')
    hall_filter = request.GET.get('hall', '')
    genre_filter = request.GET.get('genre', '')
    selected_date = request.GET.get('date', today.isoformat())
    
    # Динамический фильтр по нескольким критериям
    movies = Movie.objects.prefetch_related('screening_set__hall')
    
    if search_query:
        movies = movies.filter(Q(title__icontains=search_query) | Q(description__icontains=search_query))
    
    if genre_filter:
        movies = movies.filter(genre__name=genre_filter)
    
    # Отображение только сеансов на выбранную дату
    movies_data = []
    for movie in movies:
        screenings_on_date = movie.screening_set.filter(
            start_time__date=selected_date,
            start_time__gt=local_now
        ).order_by('start_time')
        
        movies_data.append({
            'movie': movie,
            'upcoming_screenings': screenings_on_date[:3],
            'screening_count': screenings_on_date.count()
        })
    
    return render(request, 'ticket/home.html', {'movies': movies_data})